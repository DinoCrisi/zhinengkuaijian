# 图片生成优化说明

## 问题解决

### 1. 敏感内容检测错误 (400 Bad Request)

**问题原因：**
- API检测到输入提示词可能包含敏感内容
- 某些描述词汇触发了内容安全检查

**解决方案：**
- ✅ 添加了提示词清理功能，自动过滤敏感词汇
- ✅ 实现了重试机制，失败时使用更简化的提示词
- ✅ 优化了提示词模板，使用更安全的商业摄影描述

### 2. 生成速度慢问题

**问题原因：**
- 过高的并发数导致API限流
- 没有合理的批次控制和延迟机制

**解决方案：**
- ✅ 降低默认并发数从8降至4
- ✅ 添加批次处理，每批间有1秒延迟
- ✅ 实现智能并发控制，根据成功率动态调整
- ✅ 添加详细的进度日志和统计信息

## 新增功能

### 智能并发控制
- 根据API响应成功率自动调整并发数
- 成功率>90%时增加并发，<70%时降低并发
- 避免因过度并发导致的限流问题

### 内容安全处理
- 自动检测和清理可能的敏感词汇
- 多级降级策略：原始提示词 → 简化提示词 → 基础提示词
- 提供友好的错误提示信息

### 配置化设置
- 支持通过环境变量调整并发参数
- 可配置批处理大小和延迟时间
- 支持开启/关闭内容清理功能

## 使用方法

### 1. 环境变量配置

复制 `.env.example` 到 `.env.local` 并根据需要调整：

```bash
# 推荐配置（稳定优先）
VITE_IMAGE_CONCURRENCY=3
VITE_IMAGE_BATCH_SIZE=6
VITE_IMAGE_BATCH_DELAY=1500

# 高速配置（可能不稳定）
VITE_IMAGE_CONCURRENCY=6
VITE_IMAGE_BATCH_SIZE=12
VITE_IMAGE_BATCH_DELAY=800
```

### 2. 监控生成过程

生成过程中会显示详细日志：
- 📦 批次处理进度
- ✅ 成功生成的图片
- ❌ 失败的请求和原因
- 📊 最终成功率统计
- 🚀 动态并发数调整

### 3. 错误处理

如果遇到敏感内容检测错误：
1. 系统会自动重试2次，使用更简化的提示词
2. 检查控制台日志了解具体失败原因
3. 可以手动调整商品描述，避免敏感词汇

## 性能建议

### 网络条件良好时：
- 并发数：4-6
- 批处理大小：8-12
- 批次延迟：800-1000ms

### 网络条件一般时：
- 并发数：2-3
- 批处理大小：4-6
- 批次延迟：1500-2000ms

### 遇到频繁失败时：
- 并发数：1-2
- 批处理大小：2-4
- 批次延迟：2000-3000ms

## 故障排除

### 1. 大量400错误
- 检查提示词是否包含敏感内容
- 尝试使用更简洁的商品描述
- 确保 `VITE_ENABLE_CONTENT_SANITIZATION=true`

### 2. 生成速度仍然很慢
- 降低 `VITE_IMAGE_CONCURRENCY` 值
- 增加 `VITE_IMAGE_BATCH_DELAY` 值
- 检查网络连接状况

### 3. 内存占用过高
- 降低 `VITE_IMAGE_BATCH_SIZE` 值
- 减少同时生成的图片数量
- 及时清理不需要的图片

## 更新日志

- ✅ 修复敏感内容检测导致的400错误
- ✅ 优化并发控制，提高生成成功率
- ✅ 添加智能重试机制
- ✅ 改进错误提示信息
- ✅ 添加详细的进度监控
- ✅ 支持配置化参数调整